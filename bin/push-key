#!/bin/bash -e

if [ $# -lt 2 ]; then
    echo "Usage: $(basename $0) keyfile_basename user@host [target_user]"
    echo
    echo "Arguments:"
    echo "  keyfile_basename: basename of the key file, for example id_rsa"
    echo "  user@host       : target machine and user account for logging in"
    echo "  target_user     : name of account in which to install certificate, if different from 2nd arg (optional)"
    echo 
    echo "Available key files:"
    for kf in ~/.ssh/*.pub; do
        kf=$(basename $kf)
        echo "  ${kf/.pub/}"
    done
    echo
    exit 1
fi
cmd="mkdir -p ~$3/.ssh"
cmd="$cmd; echo \"$(cat ~/.ssh/$1.pub)\" >> ~$3/.ssh/authorized_keys"
cmd="$cmd; chmod 700 ~$3/.ssh"
cmd="$cmd; chmod 600 ~$3/.ssh/*"
cmd="$cmd; [ -n \"$3\" ] && chown -R $3 ~$3/.ssh"
echo "$cmd"
ssh "$2" "$cmd"
less ~/.ssh/config

